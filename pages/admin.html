<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KraQue Admin</title>
    <link rel="shortcut icon" href="../icon.png" type="image/x-icon">

    <style>
        :root { 
            --primary: #00d10a; 
            --dark: #0d0d0d; 
            --card: #1a1a1a; 
            --text: #ffffff; 
            --success: #2ecc71; 
            --danger: #e74c3c; 
            --gray: #333; }
        
        body { 
            background: var(--dark); 
            color: var(--text); 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 10px;
        }

        .logo {
            color: white;
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .logo span { color: var(--primary); }
        
        /* Navbar */
        nav { 
            background: var(--card); 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-radius: 10px; 
            border-bottom: 3px solid var(--primary); 
            margin-bottom: 15px; 
        }
        
        .btn-status { 
            padding: 8px 15px; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
        }
        
        /* Sistema de Abas */
        .tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 15px; 
        }

        .tab-btn { 
            flex: 1; 
            padding: 12px; 
            border: none; 
            background: var(--gray); 
            color: #888; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
        }

        .tab-btn.active { 
            background: var(--primary); 
            color: #000; 
        }

        .content { 
            display: none; 
        }
        .content.active { 
            display: block; 
        }

        /* Lista de Clientes */
        ul { 
            list-style: none; 
            padding: 0; 
        }

        li { 
            background: var(--card); 
            margin-bottom: 12px; 
            padding: 15px; 
            border-radius: 12px; 
            border-left: 5px solid var(--primary); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }
        
        .client-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 12px; 
        }

        .client-info h3 { 
            margin: 0; 
            font-size: 1.1em; 
            color: var(--text); 
        }
        .client-info span { 
            font-size: 0.8em; 
            color: var(--primary); 
            font-weight: bold; 
        }
        
        /* Caixa de Contacto Oculto */
        .contact-box { 
            font-family: monospace; 
            color: #888; font-size: 0.9em; 
            margin-top: 5px; 
            background: #222; 
            padding: 6px 10px; 
            border-radius: 4px; 
            display: inline-block; 
            transition: 0.3s; 
        }

        /* Botões de Ação */
        .actions { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap; }
        .btn { flex: 1; 
            min-width: 85px; 
            padding: 10px 5px; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 0.75em; 
            text-transform: uppercase; 
            color: white; 
            transition: 0.2s; }
        
        .btn-show { 
            background: #444; 
        }
        .btn-zap { 
            background: #25d366; 
        }
        .btn-ok { 
            background: var(--success); 
        }
        .btn-cancel { 
            background: var(--danger); 
        }

        .history-li { border-left-color: #444; opacity: 0.8; }
    </style>

 </head>
<body>
    <nav>
        <span style="font-weight: bold; letter-spacing: 1px;">KraQue</span>
        <button id="btnToggleLoja" class="btn-status">...</button>
        <button id="btnLogout" style="background:none; border:none; color:#666; cursor:pointer;">Sair</button>
    </nav>

    <div class="tabs">
        <button id="tabFila" class="tab-btn active" onclick="switchTab('fila')">FILA ATUAL</button>
        <button id="tabHist" class="tab-btn" onclick="switchTab('historico')">HISTÓRICO</button>
    </div>

    <div id="fila" class="content active">
        <ul id="listaAdmin"></ul>
    </div>

    <div id="historico" class="content">
        <h4 style="color: var(--primary); margin-left: 5px;">Últimos Atendimentos (Hoje)</h4>
        <ul id="listaHistorico"></ul>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, deleteDoc, doc, getDoc, setDoc, addDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Substitua pelos seus dados reais do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCCfSRzhfRc2KCq5nJnVUHl4sgCBAflAEc",
            authDomain: "boyzzon-cortes.firebaseapp.com",
            projectId: "boyzzon-cortes",
            storageBucket: "boyzzon-cortes.firebasestorage.app",
            messagingSenderId: "546742664914",
            appId: "1:546742664914:web:94586adeb4c129d233370b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Bloqueio de Segurança
        onAuthStateChanged(auth, user => { if(!user) window.location.href="login.html"; });

        // Navegação de Abas
        window.switchTab = (id) => {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'fila') document.getElementById('tabFila').classList.add('active');
            else document.getElementById('tabHist').classList.add('active');
        };

        // Estado da Loja (Abrir/Fechar)
        const statusRef = doc(db, "configuracao", "loja");
        onSnapshot(statusRef, d => {
            const aberta = d.exists() ? d.data().aberta : true;
            btnToggleLoja.innerText = aberta ? "LOJA ABERTA" : "LOJA FECHADA";
            btnToggleLoja.style.background = aberta ? "var(--success)" : "var(--danger)";
        });

        btnToggleLoja.onclick = async () => {
            const d = await getDoc(statusRef);
            await setDoc(statusRef, { aberta: !(d.exists() ? d.data().aberta : true) });
        };

        // --- FILA ATUAL ---
        onSnapshot(query(collection(db, "agendamentos"), orderBy("criadoEm", "asc")), snap => {
            const lista = document.getElementById('listaAdmin');
            lista.innerHTML = "";
            snap.docs.forEach((d, i) => {
                const c = d.data();
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="client-info">
                        <div>
                            <span>#${i+1} NA FILA</span>
                            <h3>${c.nome}</h3>
                            <div id="tel-${d.id}" class="contact-box" data-full="${c.whatsapp}">+258 8X XXX XXXX</div>
                        </div>
                    </div>
                    <div class="actions">
                        <button id="btn-revelar-${d.id}" class="btn btn-show" onclick="window.toggleContato('${d.id}')">Mostrar</button>
                        <button class="btn btn-zap" onclick="window.chamar('${c.whatsapp}')">WhatsApp</button>
                        <button class="btn btn-ok" onclick="window.concluir('${d.id}', '${c.nome}')">OK</button>
                        <button class="btn btn-cancel" onclick="window.cancelar('${d.id}')">X</button>
                    </div>
                `;
                lista.appendChild(li);
            });
        });

        // --- HISTÓRICO ---
        onSnapshot(query(collection(db, "historico"), orderBy("finalizadoEm", "desc"), limit(15)), snap => {
            const listaH = document.getElementById('listaHistorico');
            listaH.innerHTML = "";
            snap.docs.forEach(d => {
                const li = document.createElement('li');
                li.className = "history-li";
                li.innerHTML = `<strong>${d.data().nome}</strong> <br> <small style="color:#666">Concluído hoje</small>`;
                listaH.appendChild(li);
            });
        });

        // --- FUNÇÕES DE CONTROLO ---

        // Função para Mostrar/Ocultar o contacto
        window.toggleContato = (id) => {
            const el = document.getElementById(`tel-${id}`);
            const btn = document.getElementById(`btn-revelar-${id}`);
            const numeroReal = el.getAttribute('data-full');

            if (el.innerText.includes("X")) {
                el.innerText = "+258 " + numeroReal;
                el.style.color = "var(--success)";
                btn.innerText = "Ocultar";
                btn.style.background = "#666";
            } else {
                el.innerText = "+258 8X XXX XXXX";
                el.style.color = "#888";
                btn.innerText = "Mostrar";
                btn.style.background = "#444";
            }
        };

        window.chamar = (tel) => {
            const num = tel.replace(/\D/g, "");
            const final = num.startsWith("258") ? num : "258" + num;
            window.open(`https://wa.me/${final}`, '_blank');
        };

        window.concluir = async (id, nome) => {
            if(confirm(`Atendimento de ${nome} concluído?`)) {
                await addDoc(collection(db, "historico"), { nome, finalizadoEm: serverTimestamp() });
                await deleteDoc(doc(db, "agendamentos", id));
            }
        };

        window.cancelar = async (id) => {
            if(confirm("Remover este cliente da fila?")) await deleteDoc(doc(db, "agendamentos", id));
        };

        document.getElementById('btnLogout').onclick = () => signOut(auth);
    </script>
</body>
</html>