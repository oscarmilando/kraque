<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KraQue Fila de Espera</title>
    <link rel="shortcut icon" href="../icon.png" type="image/x-icon">
    <style>
        :root { 
            --primary: #00d10a;
            --dark: #121212; 
            --card: #1e1e1e; 
            --text: #fff; 
            --success: #2ecc71; 
            --danger: #e74c3c; 
            --primary-glow: rgba(0, 209, 10, 0.3);
        }

        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background: var(--dark); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }


        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        .container { 
            width: 100%; 
            max-width: 450px;
            margin-top: 25vh; 
        }
        
        h1 { 
            color: var(--primary); 
            text-align: center; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            margin-bottom: 5px; 
        }
        
        .status-badge { 
            background: var(--primary); 
            color: #000; padding: 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            text-align: center; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(70, 243, 18, 0.3); 
        }
        
        section { 
            background: var(--card); 
            padding: 25px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            border: 1px solid #333; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            border-radius: 6px; 
            border: 1px solid #444; 
            background: #252525; 
            color: white; 
            box-sizing: border-box; 
            font-size: 16px; 
            outline: none;
        }

        input:focus { 
            border-color: var(--primary); 
        }
        
        .btn-agendar { 
            width: 100%; 
            padding: 15px; background: var(--primary); 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            text-transform: uppercase; 
            transition: 0.3s; 
        }
            
        .btn-agendar:active { 
            transform: scale(0.98); 
        }

        ul { 
            list-style: none; 
            padding: 0; 
        }
        
        li { 
            background: #2a2a2a; 
            margin-bottom: 12px; 
            padding: 15px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            border-left: 5px solid var(--primary); 
            animation: fadeIn 0.3s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .posicao { 
            background: var(--primary); 
            color: black; width: 30px; 
            height: 30px; display: flex; 
            align-items: center; 
            justify-content: 
            center; border-radius: 50%; 
            font-weight: bold; 
            margin-right: 
            15px; flex-shrink: 0; }
        
        /* Estilo para múltiplos agendamentos do mesmo dono */
        .minha-vez { 
            border-left-color: var(--success); 
            background: #1b3d2a; 
            border-left-width: 8px; 
        }
        
        .btn-cancelar-meu { 
            background: var(--danger); 
            color: white; 
            border: none; 
            padding: 6px 10px; 
            border-radius: 4px; 
            font-size: 10px; 
            cursor: pointer; 
            margin-left: auto; 
            font-weight: bold; 
            text-transform: uppercase; 
        }

        #msgFechado { 
            background: #c0392b; 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            text-align: center; 
            display: none; 
            margin-bottom: 20px; 
            border: 2px solid white; 
        }
        
        /* Menu e Navegação */

        .logo {
            color: white;
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: bold;
        }

    .logo span { color: var(--primary); }
    nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 10%;
        position: absolute;
        width: 100%;
        z-index: 1000;
        transition: var(--transition);
    }

    nav.sticky {
        position: fixed;
        background: rgba(0, 0, 0, 0.95);
        padding: 10px 10%;
    }
    .nav-links { display: flex; list-style: none; }

    .nav-links li a {
        color: white;
        text-decoration: none;
        margin-left: 30px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: var(--transition);
    }

    .nav-links

.nav-links li a:hover { color: var(--gold); }

@media (max-width: 768px) {
    nav { background: var(--dark); padding: 15px 20px; position: fixed; }
    .menu-toggle { display: flex; flex-direction: column; gap: 5px; background: none; border: none; cursor: pointer; }
    .bar { width: 25px; height: 3px; background: white; transition: 0.4s; }
    
    .nav-links {
        position: fixed; right: -100%; top: 60px; width: 100%; height: calc(100vh - 60px);
        background: var(--dark); flex-direction: column; align-items: center; padding-top: 50px; transition: 0.4s;
    }
    .nav-links.active { right: 0; }
    .nav-links li { margin: 20px 0; }
    .price-container { flex-direction: column; }
    .hero-content { padding: 40px 20px; width: 90%; }


}

.nav-links .item_menu{
        background-color: transparent;
        border: none;
    }

</style>
</head>
<body>

    <nav id="main-nav">
        <div class="logo">Kra<span>Q</span>ue</div>
        
        <button class="menu-toggle" id="mobile-menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <ul class="nav-links">
            <li class="item_menu"><a href="../index.html">Home</a></li>
            <li class="item_menu"><a href="./lista.html">Agendar Agora</a></li>
            <li class="item_menu"><a href="./login.html">Login</a></li>

        </ul>
    </nav>

    <div class="container">
        <div id="contadorFila" class="status-badge">A carregar fila...</div>

        <div id="msgFechado">
            <h2 style="margin:0">LOJA FECHADA</h2>
            <p>De momento não estamos a aceitar novos clientes.</p>
        </div>

        <section id="areaAgendamento">
            <form id="formAgendamento">
                <input type="text" id="nome" placeholder="Teu Nome" required>
                <input type="tel" id="whatsapp" placeholder="8X 000 0000" maxlength="11" required>
                <button type="submit" class="btn-agendar">ENTRAR NA FILA</button>
            </form>
            <p style="font-size: 10px; text-align: center; color: #888; margin-top: 10px;">Podes agendar para várias pessoas no mesmo telemóvel.</p>
        </section>

        <section>
            <h3 style="margin-top:0; font-size: 1.1em; border-bottom: 1px solid #333; padding-bottom: 10px;">Fila de Espera:</h3>
            <ul id="listaClientes"></ul>
        </section>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCCfSRzhfRc2KCq5nJnVUHl4sgCBAflAEc",
            authDomain: "boyzzon-cortes.firebaseapp.com",
            projectId: "boyzzon-cortes",
            storageBucket: "boyzzon-cortes.firebasestorage.app",
            messagingSenderId: "546742664914",
            appId: "1:546742664914:web:94586adeb4c129d233370b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "agendamentos");

        // 1. MÁSCARA MOÇAMBIQUE
        const inputZap = document.getElementById('whatsapp');
        inputZap.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, "");
            if (v.length > 9) v = v.slice(0, 9);
            if (v.length > 5) v = v.replace(/^(\d{2})(\d{3})(\d{0,4})/, "$1 $2 $3");
            else if (v.length > 2) v = v.replace(/^(\d{2})(\d{0,3})/, "$1 $2");
            e.target.value = v.trim();
        });

        // 2. FUNÇÃO DE NOTIFICAÇÃO
        function enviarNotificacao(titulo, corpo) {
            if (!("Notification" in window)) return;
            if (Notification.permission === "granted") {
                new Notification(titulo, { body: corpo, icon: "https://cdn-icons-png.flaticon.com/512/100/100310.png" });
            }
        }

        // 3. MONITORIZAR STATUS DA LOJA
        onSnapshot(doc(db, "configuracao", "loja"), (d) => {
            const aberta = d.exists() ? d.data().aberta : true;
            document.getElementById('areaAgendamento').style.display = aberta ? "block" : "none";
            document.getElementById('msgFechado').style.display = aberta ? "none" : "block";
        });

        // 4. FUNÇÃO PARA CANCELAR UM AGENDAMENTO ESPECÍFICO
        window.cancelarMinhaVez = async (id) => {
            if (confirm("Desejas remover este agendamento da fila?")) {
                await deleteDoc(doc(db, "agendamentos", id));
                
                // Limpar da lista local de IDs
                let idsAtivos = JSON.parse(localStorage.getItem('boyzzon_meus_ids')) || [];
                idsAtivos = idsAtivos.filter(item => item !== id);
                localStorage.setItem('boyzzon_meus_ids', JSON.stringify(idsAtivos));
                
                alert("Cancelado com sucesso.");
            }
        };

        // 5. ENTRAR NA FILA
        document.getElementById('formAgendamento').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('nome').value;
            const whatsapp = document.getElementById('whatsapp').value;

            if ("Notification" in window) await Notification.requestPermission();

            // Gravar no Firebase
            const docRef = await addDoc(colRef, {
                nome: nome,
                whatsapp: whatsapp,
                criadoEm: serverTimestamp()
            });

            // GUARDAR ID NA LISTA LOCAL (Permite múltiplos agendamentos no mesmo tlm)
            let idsAtivos = JSON.parse(localStorage.getItem('boyzzon_meus_ids')) || [];
            idsAtivos.push(docRef.id);
            localStorage.setItem('boyzzon_meus_ids', JSON.stringify(idsAtivos));

            e.target.reset();
            alert(`Sucesso! ${nome} está na fila.`);
        });

        // 6. LISTAR E MONITORIZAR POSIÇÕES
        onSnapshot(query(colRef, orderBy("criadoEm", "asc")), (snap) => {
            const listaUl = document.getElementById('listaClientes');
            listaUl.innerHTML = "";
            
            // Lista de IDs que pertencem a este telemóvel
            const meusIds = JSON.parse(localStorage.getItem('boyzzon_meus_ids')) || [];
            
            document.getElementById('contadorFila').innerText = `Pessoas na fila: ${snap.size}`;

            snap.docs.forEach((d, i) => {
                const dados = d.data();
                const posicao = i + 1;
                const li = document.createElement('li');
                
                // Se o ID do documento estiver na lista de IDs deste telemóvel
                if (meusIds.includes(d.id)) {
                    li.classList.add('minha-vez');
                    li.innerHTML = `
                        <div class="posicao">${posicao}</div>
                        <span><strong>${dados.nome} (Tu)</strong></span>
                        <button class="btn-cancelar-meu" onclick="window.cancelarMinhaVez('${d.id}')">Cancelar</button>
                    `;
                    
                    // Notificações personalizadas por nome
                    if (posicao === 1) {
                        enviarNotificacao("Tua Vez!", `${dados.nome}, o barbeiro está à tua espera!`);
                    } else if (posicao === 2) {
                        enviarNotificacao("Estás Quase!", `${dados.nome}, és o próximo na fila.`);
                    }
                } else {
                    li.innerHTML = `
                        <div class="posicao">${posicao}</div>
                        <span>${dados.nome}</span>
                    `;
                }
                listaUl.appendChild(li);
            });
        });
    </script>
    <script src="../js/main.js"></script>
    

</body>
</html>